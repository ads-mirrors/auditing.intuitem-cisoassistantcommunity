<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>EBIOS RM Report - {{ study.name }}</title>
    <style>
        @page {
            size: A4;
            margin: 2cm;
            @bottom-right {
                content: counter(page) " / " counter(pages);
            }
        }
        body {
            font-family: Arial, sans-serif;
            font-size: 10pt;
            line-height: 1.4;
        }
        h1 {
            font-size: 20pt;
            color: #1f2937;
            margin-bottom: 10px;
        }
        h2 {
            font-size: 16pt;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 5px;
            margin-top: 20px;
            margin-bottom: 10px;
            page-break-after: avoid;
        }
        h3 {
            font-size: 13pt;
            color: #4b5563;
            margin-top: 15px;
            margin-bottom: 8px;
            page-break-after: avoid;
        }
        h4 {
            font-size: 11pt;
            color: #6b7280;
            margin-top: 10px;
            margin-bottom: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            page-break-inside: avoid;
        }
        th {
            background-color: #f9fafb;
            padding: 8px;
            text-align: left;
            border: 1px solid #d1d5db;
            font-weight: bold;
            font-size: 9pt;
        }
        td {
            padding: 6px 8px;
            border: 1px solid #e5e7eb;
            font-size: 9pt;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .info-item {
            font-size: 9pt;
        }
        .info-label {
            font-weight: bold;
            color: #4b5563;
        }
        .chart-image {
            width: 100%;
            max-width: 600px;
            height: auto;
            margin: 10px auto;
            display: block;
        }
        .section {
            margin-bottom: 20px;
        }
        .card {
            border: 1px solid #e5e7eb;
            padding: 10px;
            margin: 10px 0;
            background-color: #f9fafb;
            page-break-inside: avoid;
        }
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 8pt;
            font-weight: bold;
        }
        .page-break {
            page-break-before: always;
        }
    </style>
</head>
<body>
    <!-- Study Header -->
    <h1>{{ study.name }}</h1>
    {% if study.description %}
        <p>{{ study.description }}</p>
    {% endif %}

    <div class="info-grid">
        <div class="info-item">
            <span class="info-label">Version:</span> {{ study.version|default:"N/A" }}
        </div>
        <div class="info-item">
            <span class="info-label">Status:</span> {{ study.get_status_display|default:"N/A" }}
        </div>
        <div class="info-item">
            <span class="info-label">ETA:</span> {{ study.eta|date:"Y-m-d"|default:"--" }}
        </div>
        <div class="info-item">
            <span class="info-label">Due Date:</span> {{ study.due_date|date:"Y-m-d"|default:"--" }}
        </div>
    </div>

    <!-- Feared Events -->
    {% if feared_events %}
    <div class="section">
        <h2>Feared Events ({{ feared_events.count }})</h2>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Gravity</th>
                    <th>Assets</th>
                </tr>
            </thead>
            <tbody>
                {% for event in feared_events %}
                <tr>
                    <td>{{ event.name }}</td>
                    <td>{{ event.get_gravity_display.name }}</td>
                    <td>{{ event.assets.count }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Compliance Assessments -->
    {% if compliance_assessments %}
    <div class="section">
        <h2>Compliance Assessments ({{ compliance_assessments|length }})</h2>
        {% for assessment in compliance_assessments %}
        <div class="card">
            <h3>{{ assessment.name }}{% if assessment.framework %} ({{ assessment.framework }}){% endif %}</h3>
            <p><strong>Progress:</strong> {{ assessment.progress }}%</p>
            {% if assessment.result_counts %}
            <table style="margin-top: 10px;">
                <thead>
                    <tr>
                        <th>Result</th>
                        <th>Count</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result, count in assessment.result_counts.items %}
                    <tr>
                        <td>{{ result }}</td>
                        <td>{{ count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- RO/TO Couples -->
    {% if ro_to_couples %}
    <div class="section page-break">
        <h2>RO/TO Couples ({{ ro_to_couples.count }})</h2>
        <table>
            <thead>
                <tr>
                    <th>Risk Origin</th>
                    <th>Target Objective</th>
                    <th>Motivation</th>
                    <th>Pertinence</th>
                </tr>
            </thead>
            <tbody>
                {% for roto in ro_to_couples %}
                <tr>
                    <td>{{ roto.risk_origin.get_name_translated }}</td>
                    <td>{{ roto.target_objective }}</td>
                    <td>{{ roto.get_motivation_display }}</td>
                    <td>{{ roto.get_pertinence_display }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Stakeholders -->
    {% if stakeholders %}
    <div class="section">
        <h2>Stakeholders ({{ stakeholders.count }})</h2>
        <table>
            <thead>
                <tr>
                    <th>Entity</th>
                    <th>Category</th>
                    <th>Current Criticality</th>
                    <th>Residual Criticality</th>
                </tr>
            </thead>
            <tbody>
                {% for stakeholder in stakeholders %}
                <tr>
                    <td>{{ stakeholder.entity.name }}</td>
                    <td>{{ stakeholder.get_category_display }}</td>
                    <td>{{ stakeholder.get_current_criticality_display }}</td>
                    <td>{{ stakeholder.get_residual_criticality_display }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Ecosystem Radar Charts -->
    {% if radar_current_image or radar_residual_image %}
    <div class="section page-break">
        <h2>Ecosystem Radar</h2>
        {% if radar_current_image %}
        <h3>Current</h3>
        <img src="{{ radar_current_image }}" class="chart-image" alt="Current Radar Chart"/>
        {% endif %}
        {% if radar_residual_image %}
        <h3>Residual</h3>
        <img src="{{ radar_residual_image }}" class="chart-image" alt="Residual Radar Chart"/>
        {% endif %}
    </div>
    {% endif %}

    <!-- Operational Scenarios -->
    {% if operational_scenarios %}
    <div class="section page-break">
        <h2>Operational Scenarios ({{ operational_scenarios.count }})</h2>
        {% for scenario in operational_scenarios %}
        <div class="card">
            <h3>{{ scenario.ref_id|default:"Operational Scenario" }}</h3>
            {% if scenario.operating_modes_description %}
            <p>{{ scenario.operating_modes_description }}</p>
            {% endif %}
            <p>
                <span class="info-label">Likelihood:</span> {{ scenario.get_likelihood_display.name }} |
                <span class="info-label">Gravity:</span> {{ scenario.get_gravity_display.name }} |
                <span class="info-label">Risk Level:</span> {{ scenario.get_risk_level_display.name }}
            </p>

            <!-- Operating Modes -->
            {% for mode in operating_modes %}
            {% if mode.operational_scenario.id == scenario.id %}
            <h4>{{ mode.name }}</h4>
            {% if mode.description %}
            <p style="font-size: 8pt;">{{ mode.description }}</p>
            {% endif %}

            <!-- Operating Mode Graph -->
            {% if operating_mode_graphs %}
            {% for mode_id, graph_image in operating_mode_graphs.items %}
            {% if mode_id == mode.id|stringformat:"s" %}
            <img src="{{ graph_image }}" class="chart-image" alt="Kill Chain Graph for {{ mode.name }}" style="max-width: 500px;"/>
            {% endif %}
            {% endfor %}
            {% endif %}
            {% endif %}
            {% endfor %}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Risk Matrices -->
    {% if risk_matrix_current_image or risk_matrix_residual_image %}
    <div class="section page-break">
        <h2>Risk Matrices</h2>
        {% if risk_matrix_current_image %}
        <h3>Current Risk</h3>
        <img src="{{ risk_matrix_current_image }}" class="chart-image" alt="Current Risk Matrix"/>
        {% endif %}
        {% if risk_matrix_residual_image %}
        <h3>Residual Risk</h3>
        <img src="{{ risk_matrix_residual_image }}" class="chart-image" alt="Residual Risk Matrix"/>
        {% endif %}
    </div>
    {% endif %}

    <!-- Treatment Plan -->
    {% if compliance_action_plans or risk_action_plan_controls %}
    <div class="section page-break">
        <h2>Treatment Plan</h2>

        <!-- Compliance Assessment Action Plans -->
        {% for action_plan in compliance_action_plans %}
        <h3>{{ action_plan.assessment_name }}{% if action_plan.framework %} ({{ action_plan.framework }}){% endif %}</h3>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th>Owner</th>
                    <th>ETA</th>
                </tr>
            </thead>
            <tbody>
                {% for control in action_plan.controls %}
                <tr>
                    <td>{{ control.name }}</td>
                    <td>{{ control.get_priority_display|default:"--" }}</td>
                    <td>{{ control.get_status_display|default:"--" }}</td>
                    <td>{{ control.owner.email|default:"--" }}</td>
                    <td>{{ control.eta|date:"Y-m-d"|default:"--" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endfor %}

        <!-- Risk Assessment Action Plan -->
        {% if risk_action_plan_controls %}
        <h3>Risk Assessment Action Plan</h3>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th>Owner</th>
                    <th>ETA</th>
                </tr>
            </thead>
            <tbody>
                {% for control in risk_action_plan_controls %}
                <tr>
                    <td>{{ control.name }}</td>
                    <td>{{ control.get_priority_display|default:"--" }}</td>
                    <td>{{ control.get_status_display|default:"--" }}</td>
                    <td>{{ control.owner.email|default:"--" }}</td>
                    <td>{{ control.eta|date:"Y-m-d"|default:"--" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>
    {% endif %}
</body>
</html>
