<script lang="ts">
	import TreemapChart from '$lib/components/Chart/TreemapChart.svelte';
	import LoadingSpinner from '$lib/components/utils/LoadingSpinner.svelte';
	import { pageTitle } from '$lib/utils/stores';
	import { safeTranslate } from '$lib/utils/i18n';
	import type { PageData } from './$types';

	interface Props {
		data: PageData;
	}

	let { data }: Props = $props();

	$pageTitle = 'Vulnerability Treemap';

	// Define available severities and statuses based on actual Vulnerability model (lowercase keys from backend)
	const severityOptions = ['critical', 'high', 'medium', 'low', 'info', 'undefined'];
	const statusOptions = [
		'potential',
		'exploitable',
		'mitigated',
		'fixed',
		'not_exploitable',
		'unaffected',
		'--'
	];

	// State for filters - exclude Undefined by default
	let selectedSeverities = $state<string[]>(['critical', 'high', 'medium', 'low', 'info']);
	let selectedStatuses = $state<string[]>([
		'potential',
		'exploitable',
		'mitigated',
		'fixed',
		'not_exploitable',
		'unaffected'
	]);

	// Function to filter and translate data for display
	function filterTreemapData(rawData: any[]) {
		if (!Array.isArray(rawData)) {
			return [];
		}

		return rawData
			.map((domain) => {
				const filteredChildren = domain.children
					.filter((severity: any) => selectedSeverities.includes(severity.name))
					.map((severity: any) => ({
						...severity,
						name: safeTranslate(severity.name), // Translate severity for display
						children: severity.children
							.filter((status: any) => selectedStatuses.includes(status.name))
							.map((status: any) => ({
								...status,
								name: safeTranslate(status.name) // Translate status for display
							}))
					}))
					.filter((severity: any) => severity.children.length > 0);

				return {
					...domain,
					children: filteredChildren
				};
			})
			.filter((domain) => domain.children.length > 0);
	}

	// Dummy data structure for reference (can be removed)
	const dummyData = [
		{
			name: 'Infrastructure',
			id: 'infrastructure',
			children: [
				{
					name: 'Critical',
					id: 'critical',
					children: [
						{ name: 'Potential', id: 'potential-1', value: 3 },
						{ name: 'Exploitable', id: 'exploitable-1', value: 2 },
						{ name: 'Mitigated', id: 'mitigated-1', value: 4 },
						{ name: 'Fixed', id: 'fixed-1', value: 1 }
					]
				},
				{
					name: 'High',
					id: 'high',
					children: [
						{ name: 'Potential', id: 'potential-2', value: 8 },
						{ name: 'Exploitable', id: 'exploitable-2', value: 5 },
						{ name: 'Mitigated', id: 'mitigated-2', value: 12 },
						{ name: 'Fixed', id: 'fixed-2', value: 10 },
						{ name: 'Not exploitable', id: 'not-exploitable-2', value: 3 }
					]
				},
				{
					name: 'Medium',
					id: 'medium',
					children: [
						{ name: 'Potential', id: 'potential-3', value: 15 },
						{ name: 'Exploitable', id: 'exploitable-3', value: 8 },
						{ name: 'Mitigated', id: 'mitigated-3', value: 20 },
						{ name: 'Fixed', id: 'fixed-3', value: 18 },
						{ name: 'Not exploitable', id: 'not-exploitable-3', value: 7 }
					]
				},
				{
					name: 'Low',
					id: 'low',
					children: [
						{ name: 'Potential', id: 'potential-4', value: 10 },
						{ name: 'Mitigated', id: 'mitigated-4', value: 8 },
						{ name: 'Fixed', id: 'fixed-4', value: 25 },
						{ name: 'Not exploitable', id: 'not-exploitable-4', value: 5 }
					]
				}
			]
		},
		{
			name: 'Applications',
			id: 'applications',
			children: [
				{
					name: 'Critical',
					id: 'critical-2',
					children: [
						{ name: 'Potential', id: 'potential-5', value: 2 },
						{ name: 'Exploitable', id: 'exploitable-5', value: 1 },
						{ name: 'Mitigated', id: 'mitigated-5', value: 2 },
						{ name: 'Fixed', id: 'fixed-5', value: 1 }
					]
				},
				{
					name: 'High',
					id: 'high-2',
					children: [
						{ name: 'Potential', id: 'potential-6', value: 6 },
						{ name: 'Exploitable', id: 'exploitable-6', value: 4 },
						{ name: 'Mitigated', id: 'mitigated-6', value: 10 },
						{ name: 'Fixed', id: 'fixed-6', value: 8 },
						{ name: 'Not exploitable', id: 'not-exploitable-6', value: 4 }
					]
				},
				{
					name: 'Medium',
					id: 'medium-2',
					children: [
						{ name: 'Potential', id: 'potential-7', value: 18 },
						{ name: 'Exploitable', id: 'exploitable-7', value: 10 },
						{ name: 'Mitigated', id: 'mitigated-7', value: 22 },
						{ name: 'Fixed', id: 'fixed-7', value: 20 },
						{ name: 'Not exploitable', id: 'not-exploitable-7', value: 8 }
					]
				},
				{
					name: 'Low',
					id: 'low-2',
					children: [
						{ name: 'Potential', id: 'potential-8', value: 12 },
						{ name: 'Mitigated', id: 'mitigated-8', value: 15 },
						{ name: 'Fixed', id: 'fixed-8', value: 30 },
						{ name: 'Not exploitable', id: 'not-exploitable-8', value: 10 },
						{ name: 'Unaffected', id: 'unaffected-8', value: 3 }
					]
				},
				{
					name: 'Info',
					id: 'info-1',
					children: [
						{ name: 'Potential', id: 'potential-9', value: 5 },
						{ name: 'Fixed', id: 'fixed-9', value: 15 },
						{ name: 'Not exploitable', id: 'not-exploitable-9', value: 8 }
					]
				}
			]
		},
		{
			name: 'Cloud Services',
			id: 'cloud',
			children: [
				{
					name: 'Critical',
					id: 'critical-3',
					children: [
						{ name: 'Potential', id: 'potential-10', value: 1 },
						{ name: 'Exploitable', id: 'exploitable-10', value: 1 },
						{ name: 'Mitigated', id: 'mitigated-10', value: 4 },
						{ name: 'Fixed', id: 'fixed-10', value: 3 }
					]
				},
				{
					name: 'High',
					id: 'high-3',
					children: [
						{ name: 'Potential', id: 'potential-11', value: 7 },
						{ name: 'Exploitable', id: 'exploitable-11', value: 3 },
						{ name: 'Mitigated', id: 'mitigated-11', value: 9 },
						{ name: 'Fixed', id: 'fixed-11', value: 11 },
						{ name: 'Not exploitable', id: 'not-exploitable-11', value: 4 }
					]
				},
				{
					name: 'Medium',
					id: 'medium-3',
					children: [
						{ name: 'Potential', id: 'potential-12', value: 12 },
						{ name: 'Exploitable', id: 'exploitable-12', value: 6 },
						{ name: 'Mitigated', id: 'mitigated-12', value: 16 },
						{ name: 'Fixed', id: 'fixed-12', value: 18 },
						{ name: 'Not exploitable', id: 'not-exploitable-12', value: 8 }
					]
				},
				{
					name: 'Low',
					id: 'low-3',
					children: [
						{ name: 'Potential', id: 'potential-13', value: 8 },
						{ name: 'Mitigated', id: 'mitigated-13', value: 5 },
						{ name: 'Fixed', id: 'fixed-13', value: 20 },
						{ name: 'Not exploitable', id: 'not-exploitable-13', value: 5 }
					]
				},
				{
					name: 'Info',
					id: 'info-2',
					children: [
						{ name: 'Potential', id: 'potential-14', value: 10 },
						{ name: 'Fixed', id: 'fixed-14', value: 30 },
						{ name: 'Not exploitable', id: 'not-exploitable-14', value: 13 }
					]
				}
			]
		},
		{
			name: 'Network',
			id: 'network',
			children: [
				{
					name: 'High',
					id: 'high-4',
					children: [
						{ name: 'Potential', id: 'potential-15', value: 4 },
						{ name: 'Exploitable', id: 'exploitable-15', value: 2 },
						{ name: 'Mitigated', id: 'mitigated-15', value: 6 },
						{ name: 'Fixed', id: 'fixed-15', value: 6 }
					]
				},
				{
					name: 'Medium',
					id: 'medium-4',
					children: [
						{ name: 'Potential', id: 'potential-16', value: 9 },
						{ name: 'Exploitable', id: 'exploitable-16', value: 4 },
						{ name: 'Mitigated', id: 'mitigated-16', value: 11 },
						{ name: 'Fixed', id: 'fixed-16', value: 14 },
						{ name: 'Not exploitable', id: 'not-exploitable-16', value: 4 }
					]
				},
				{
					name: 'Low',
					id: 'low-4',
					children: [
						{ name: 'Potential', id: 'potential-17', value: 6 },
						{ name: 'Mitigated', id: 'mitigated-17', value: 4 },
						{ name: 'Fixed', id: 'fixed-17', value: 15 },
						{ name: 'Not exploitable', id: 'not-exploitable-17', value: 5 }
					]
				}
			]
		}
	];

	function toggleSeverity(severity: string) {
		if (selectedSeverities.includes(severity)) {
			selectedSeverities = selectedSeverities.filter((s) => s !== severity);
		} else {
			selectedSeverities = [...selectedSeverities, severity];
		}
	}

	function toggleStatus(status: string) {
		if (selectedStatuses.includes(status)) {
			selectedStatuses = selectedStatuses.filter((s) => s !== status);
		} else {
			selectedStatuses = [...selectedStatuses, status];
		}
	}

	function selectAllSeverities() {
		selectedSeverities = [...severityOptions];
	}

	function clearAllSeverities() {
		selectedSeverities = [];
	}

	function selectAllStatuses() {
		selectedStatuses = [...statusOptions];
	}

	function clearAllStatuses() {
		selectedStatuses = [];
	}

	// Severity colors for visual consistency (using lowercase keys)
	const severityColors: Record<string, string> = {
		critical: 'bg-red-100 border-red-300 text-red-800',
		high: 'bg-orange-100 border-orange-300 text-orange-800',
		medium: 'bg-yellow-100 border-yellow-300 text-yellow-800',
		low: 'bg-blue-100 border-blue-300 text-blue-800',
		info: 'bg-gray-100 border-gray-300 text-gray-800',
		undefined: 'bg-slate-100 border-slate-300 text-slate-800'
	};

	// Status colors based on vulnerability lifecycle (using raw status values)
	const statusColors: Record<string, string> = {
		potential: 'bg-yellow-100 border-yellow-300 text-yellow-800',
		exploitable: 'bg-red-100 border-red-300 text-red-800',
		mitigated: 'bg-blue-100 border-blue-300 text-blue-800',
		fixed: 'bg-green-100 border-green-300 text-green-800',
		not_exploitable: 'bg-teal-100 border-teal-300 text-teal-800',
		unaffected: 'bg-emerald-100 border-emerald-300 text-emerald-800',
		'--': 'bg-slate-100 border-slate-300 text-slate-800'
	};
</script>

<div class="bg-white p-6 h-screen overflow-auto">
	<div class="mb-4">
		<h1 class="text-2xl font-bold">Vulnerability Distribution Treemap</h1>
		<p class="text-gray-600 mt-2">
			Hierarchical view: Domains → Severity → Status (with dummy data)
		</p>
	</div>

	<!-- Filters Section -->
	<div class="mb-6 space-y-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
		<!-- Severity Filters -->
		<div>
			<div class="flex items-center justify-between mb-2">
				<label class="text-sm font-semibold text-gray-700">Filter by Severity:</label>
				<div class="space-x-2">
					<button
						onclick={selectAllSeverities}
						class="text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600"
					>
						Select All
					</button>
					<button
						onclick={clearAllSeverities}
						class="text-xs px-2 py-1 bg-gray-400 text-white rounded hover:bg-gray-500"
					>
						Clear All
					</button>
				</div>
			</div>
			<div class="flex flex-wrap gap-2">
				{#each severityOptions as severity}
					<button
						onclick={() => toggleSeverity(severity)}
						class="px-3 py-1.5 rounded border-2 transition-all {selectedSeverities.includes(
							severity
						)
							? severityColors[severity]
							: 'bg-white border-gray-300 text-gray-400'}"
					>
						{safeTranslate(severity)}
						{#if selectedSeverities.includes(severity)}
							<span class="ml-1">✓</span>
						{/if}
					</button>
				{/each}
			</div>
		</div>

		<!-- Status Filters -->
		<div>
			<div class="flex items-center justify-between mb-2">
				<label class="text-sm font-semibold text-gray-700">Filter by Status:</label>
				<div class="space-x-2">
					<button
						onclick={selectAllStatuses}
						class="text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600"
					>
						Select All
					</button>
					<button
						onclick={clearAllStatuses}
						class="text-xs px-2 py-1 bg-gray-400 text-white rounded hover:bg-gray-500"
					>
						Clear All
					</button>
				</div>
			</div>
			<div class="flex flex-wrap gap-2">
				{#each statusOptions as status}
					<button
						onclick={() => toggleStatus(status)}
						class="px-3 py-1.5 rounded border-2 transition-all {selectedStatuses.includes(status)
							? statusColors[status]
							: 'bg-white border-gray-300 text-gray-400'}"
					>
						{safeTranslate(status)}
						{#if selectedStatuses.includes(status)}
							<span class="ml-1">✓</span>
						{/if}
					</button>
				{/each}
			</div>
		</div>
	</div>

	<!-- Treemap -->
	<div class="h-[calc(100vh-400px)]">
		{#await data.stream.treemapData}
			<div class="flex items-center justify-center h-full">
				<LoadingSpinner />
			</div>
		{:then loadedData}
			{#key `${selectedSeverities.join(',')}-${selectedStatuses.join(',')}`}
				{@const filteredData = filterTreemapData(loadedData)}
				{#if filteredData.length === 0}
					<div class="flex items-center justify-center h-full text-gray-500">
						No data matches the selected filters
					</div>
				{:else}
					<TreemapChart
						tree={filteredData}
						name="vulnerability_treemap"
						title="Click to drill down"
					/>
				{/if}
			{/key}
		{:catch error}
			<div class="flex items-center justify-center h-full text-red-500">
				Failed to load vulnerability data: {error.message}
			</div>
		{/await}
	</div>
</div>
