<script lang="ts">
	import LoadingSpinner from '$lib/components/utils/LoadingSpinner.svelte';
	import { pageTitle } from '$lib/utils/stores';
	import { safeTranslate } from '$lib/utils/i18n';
	import { onMount } from 'svelte';
	import type { PageData } from './$types';

	interface Props {
		data: PageData;
	}

	let { data }: Props = $props();

	$pageTitle = 'Vulnerability Flow Diagram';

	let chartContainer: HTMLDivElement;
	let chart: any = null;

	// Extract unique nodes from links
	function extractNodes(links: any[]) {
		const nodeSet = new Set<string>();
		links.forEach((link) => {
			nodeSet.add(link.source);
			nodeSet.add(link.target);
		});
		return Array.from(nodeSet).map((name) => ({ name }));
	}

	async function renderChart(element: HTMLElement, sankeyData: any[]) {
		if (!sankeyData || sankeyData.length === 0) return;

		const echarts = await import('echarts');

		chart = echarts.init(element, null, { renderer: 'svg' });

		const handleResize = () => {
			if (chart) chart.resize();
		};
		window.addEventListener('resize', handleResize);

		const nodes = extractNodes(sankeyData);

		const option = {
			title: {
				text: 'Vulnerability Distribution Flow',
				subtext: 'Domains → Severity → Status'
			},
			tooltip: {
				trigger: 'item',
				triggerOn: 'mousemove'
			},
			series: {
				type: 'sankey',
				layout: 'none',
				orient: 'horizontal',
				emphasis: {
					focus: 'adjacency'
				},
				data: nodes,
				links: sankeyData,
				lineStyle: {
					color: 'gradient',
					curveness: 0.5
				},
				label: {
					formatter: (params: any) => {
						// Translate severity and status labels
						return safeTranslate(params.name);
					}
				}
			}
		};

		chart.setOption(option);

		return {
			destroy() {
				window.removeEventListener('resize', handleResize);
				if (chart) {
					chart.dispose();
					chart = null;
				}
			}
		};
	}

	onMount(() => {
		return () => {
			if (chart) {
				chart.dispose();
				chart = null;
			}
		};
	});
</script>

<div class="bg-white p-6 h-screen overflow-auto">
	<div class="mb-4">
		<h1 class="text-2xl font-bold">Vulnerability Flow Diagram</h1>
		<p class="text-gray-600 mt-2">Sankey flow visualization: Domains → Severity → Status</p>
	</div>

	<!-- Sankey Diagram -->
	<div class="h-[calc(100vh-200px)] bg-white rounded-lg border border-gray-200 shadow-sm">
		{#await data.stream.sankeyData}
			<div class="flex items-center justify-center h-full">
				<LoadingSpinner />
			</div>
		{:then loadedData}
			{#if loadedData.length === 0}
				<div class="flex items-center justify-center h-full text-gray-500">
					No vulnerability data available
				</div>
			{:else}
				<div bind:this={chartContainer} class="w-full h-full" use:renderChart={loadedData}></div>
			{/if}
		{:catch error}
			<div class="flex items-center justify-center h-full text-red-500">
				Failed to load vulnerability data: {error.message}
			</div>
		{/await}
	</div>
</div>
